SELECT
  WFP.IDOBJECT
 ,WFP.IDPROCESS
  ,FORM.DATAINICIO
 ,CASE WFP.FGSTATUS
    WHEN 1 THEN 'Andamento'
    WHEN 2 THEN 'Suspenso'
    WHEN 3 THEN 'Cancelado'
    WHEN 4 THEN 'Encerrado'
    WHEN 5 THEN 'Bloqueado para edição'
  END AS SITUACAOPROCESS
 ,WFP.NMPROCESS
 ,WFP.CDPROCESSMODEL
 ,WFP.CDREVISION
 ,WFP.IDPROCESSMODEL
 ,WFP.NMPROCESSMODEL
 ,WFP.FGSTATUS
 ,WFP.DTSTART AS WFDTSTART
 ,WFP.DTFINISH AS WFDTFINSH
 ,CASE
    WHEN GNACT.FGSTATUS = 1 OR
      GNACT.FGSTATUS = 2 THEN CASE
        WHEN (TMCPLAN.FGIMMEDIATEACTION = 2 OR
          TMCPLAN.FGIMMEDIATEACTION IS NULL) THEN CASE
            WHEN (GNACT.DTSTARTPLAN IS NOT NULL AND
              GNACT.DTSTARTPLAN < GETDATE()) THEN '#{100899}'
            WHEN (GNACT.DTSTARTPLAN IS NULL OR
              GNACT.DTSTARTPLAN >= GETDATE()) THEN '#{100900}'
          END
        ELSE '#{100900}'
      END
    WHEN GNACT.FGSTATUS = 3 OR
      GNACT.FGSTATUS = 13 THEN CASE
        WHEN (GNACT.DTSTART IS NULL) THEN CASE
            WHEN (GNACT.DTSTARTPLAN < GETDATE()) THEN '#{100899}'
            WHEN (GNACT.DTSTARTPLAN > dbo.SEF_DTEND_WK_DAYS_PERIOD(GETDATE(), 4, (GNACT.CDCALENDAR))) THEN '#{100900}'
            ELSE '#{201639}'
          END
        WHEN (GNACT.DTSTART IS NOT NULL AND
          GNACT.DTFINISH IS NULL) THEN CASE
            WHEN (GNACT.DTFINISHPLAN < GETDATE()) THEN '#{100899}'
            WHEN (GNACT.DTFINISHPLAN > dbo.SEF_DTEND_WK_DAYS_PERIOD(GETDATE(), 4, (GNACT.CDCALENDAR))) THEN '#{100900}'
            ELSE '#{201639}'
          END
        WHEN (GNACT.DTSTART IS NOT NULL AND
          GNACT.DTFINISH IS NOT NULL) THEN CASE
            WHEN (GNACT.DTFINISH <= GNACT.DTFINISHPLAN) THEN '#{100900}'
            WHEN (GNACT.DTFINISH > GNACT.DTFINISHPLAN) THEN '#{100899}'
          END
      END
    WHEN GNACT.FGSTATUS = 5 OR
      GNACT.FGSTATUS = 4 THEN CASE
        WHEN (GNACT.DTSTARTPLAN IS NULL OR
          GNACT.DTFINISH <= GNACT.DTFINISHPLAN) THEN '#{100900}'
        ELSE '#{100899}'
      END
  END AS PLANDEADLINE
 ,CASE
    WHEN GNACT.FGSTATUS = 1 THEN '#{100470}'
    WHEN GNACT.FGSTATUS = 2 THEN '#{200135}'
    WHEN GNACT.FGSTATUS = 3 THEN '#{200002}'
    WHEN GNACT.FGSTATUS = 4 AND
      GNACT.CDACTIVITYOWNER IS NOT NULL THEN '#{200381}'
    WHEN GNACT.FGSTATUS = 4 AND
      GNACT.CDACTIVITYOWNER IS NULL THEN '#{100476}'
    WHEN GNACT.FGSTATUS = 5 THEN '#{101237}'
    WHEN GNACT.FGSTATUS = 6 THEN '#{104230}'
  END AS PLANACTSTATUS
 ,GNACT.IDACTIVITY
 ,GNACT.NMACTIVITY
 ,CASE WHEN PLACOES.NMACTIVITY IS NOT NULL then PLACOES.NMACTIVITY ELSE 'Sem Ação' end AS PLANOACOES
 ,GNACT.DTSTARTPLAN AS PLANDTSTART
 ,GNACT.DTFINISHPLAN AS PLANDTFINSH
 ,GNACT.DTSTART
 ,GNACT.DTFINISH
 ,CAST(GNACT.VLPERCENTAGEM AS INTEGER) AS ACTPERCENT
 ,GNTP.IDGENTYPE
 ,GNTP.NMGENTYPE
 ,GNRESUACT.NMEVALRESULT
 ,ADUSR2.NMUSER AS RESPONSAVEL_PLAN
 ,ADUSR2.IDUSER AS IDACTIONPLANRESP
   ,CASE
    WHEN ADUSRACTPLAN.NMUSER IS NULL THEN ADUSR2.NMUSER
    ELSE ADUSRACTPLAN.NMUSER
  END AS QUEM
 ,ATTIT.NMSTRING AS TITULO
 ,ATAPE.NMSTRING AS UNIAPELIDO
 ,FORM.ENTIDADE
 ,FORM.UNIDADE
 ,FORM.OBJETIVO
FROM WFPROCESS WFP
INNER JOIN WFSTRUCT WFS
  ON (WFP.IDOBJECT = WFS.IDPROCESS)
INNER JOIN WFASSOCACTIONPLAN WFAS
  ON (WFS.IDOBJECT = WFAS.IDACTIVITY)
LEFT JOIN GNASSOCACTIONPLAN GNAS
  ON (WFAS.CDASSOCACTIONPLAN = GNAS.CDASSOCACTIONPLAN)
LEFT JOIN GNACTIVITY GNACT
  ON (GNACT.CDGENACTIVITY = GNAS.CDACTIONPLAN)
LEFT JOIN GNACTIVITY PLACOES
  ON GNACT.CDGENACTIVITY = PLACOES.CDACTIVITYOWNER
LEFT JOIN INOCCURRENCE INO
  ON (WFP.IDOBJECT = INO.IDWORKFLOW)
LEFT JOIN INOCCURRENCETYPE INOTYPE
  ON (INO.CDOCCURRENCETYPE = INOTYPE.CDOCCURRENCETYPE)
LEFT JOIN GNGENTYPE GNTP
  ON (INO.CDOCCURRENCETYPE = GNTP.CDGENTYPE
      AND GNTP.CDISOSYSTEM = 160)
LEFT OUTER JOIN GNEVALRESULTUSED GNEVALRESACT
  ON (GNEVALRESACT.CDEVALRESULTUSED = GNACT.CDEVALRSLTPRIORITY)
LEFT OUTER JOIN GNEVALRESULT GNRESUACT
  ON (GNRESUACT.CDEVALRESULT = GNEVALRESACT.CDEVALRESULT)
LEFT OUTER JOIN ADUSER ADUSR
  ON (ADUSR.CDUSER = GNACT.CDUSER)
LEFT OUTER JOIN ADUSER ADUSRACTPLAN
  ON (ADUSRACTPLAN.CDUSER = PLACOES.CDUSER)
LEFT OUTER JOIN ADUSER ADUSR2
  ON (ADUSR2.CDUSER = GNACT.CDUSERACTIVRESP)
LEFT OUTER JOIN GNTMCACTIONPLAN TMCPLAN
  ON (TMCPLAN.CDGENACTIVITY = GNACT.CDGENACTIVITY)
INNER JOIN WFPROCATTRIB ATENT
  ON (ATENT.IDPROCESS = WFP.IDOBJECT
      AND ATENT.CDATTRIBUTE = 151)-- ENTIDADE
INNER JOIN WFPROCATTRIB ATAPE
  ON (ATAPE.IDPROCESS = WFP.IDOBJECT
      AND ATAPE.CDATTRIBUTE = 152)-- APELIDO
INNER JOIN WFPROCATTRIB ATTIT
  ON (ATTIT.IDPROCESS = WFP.IDOBJECT
      AND ATTIT.CDATTRIBUTE = 195)-- TITULO
INNER JOIN GNASSOCFORMREG GNA
  ON GNA.CDASSOC = WFP.CDASSOCREG
INNER JOIN DYNfplanger FORM
  ON FORM.OID = GNA.OIDENTITYREG
WHERE 1 = 1
AND WFP.CDPROCESSMODEL = 1070
